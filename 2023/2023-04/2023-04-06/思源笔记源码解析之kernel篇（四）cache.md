---
title: 思源笔记源码解析之kernel篇（四）cache
date: 2023-04-06 19:02:57
categories:
 - [不看会后悔的实用技巧分享, 源码解析, 思源笔记]
tags: 
 - 思源笔记
---

## 总结

根据以上你自己的分析，对程序的整体功能和构架做出概括。然后用一张 markdown 表格整理每个文件的功能

### 程序概述

该程序是一个缓存工具，用于加速数据文件读取，具体实现中使用了 Golang ristretto 缓存库。主要功能是加载所有的数据文件，并将文件信息存入到缓存中，方便快速查找和读取。

### 程序构架

* 数据文件加载：通过 `LoadAssets()` 函数，读取项目中所有的数据文件，提取文件路径和文件信息，并将其存入到 `assetsCache` 中；
* 缓存操作：通过定义的 `docIALCache` 和 `blockIALCache` 两个缓存变量，实现缓存数据的快速读取、修改、删除等操作；
* 互斥锁保护：由于多个协程可能同时访问缓存，需要使用 `assetsLock` 互斥锁来保护并发读写的安全性。

文件功能

| 文件名   | 功能                                                                                                                           |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------- |
| asset.go | 实现对所有数据文件的缓存处理，以便快速地获取和查询数据文件的信息和所在路径。                                                   |
| ial.go   | 定义了两个缓存变量：docIALCache 和 blockIALCache，用于缓存文档和块的 IAL（内部属性列表），提供了增删改查等公共方法供缓存操作。 |

## [0/2] asset.go

该文件是 `siyuan-note` 项目中的缓存处理相关的代码文件 `asset.go`，包含以下主要功能：

1. 定义了一个 `Asset` 的结构体，用于表示文件的相关信息；
2. 定义了一个名为 `assetsCache` 的全局变量用于保存所有的 `Asset` 对象；
3. 定义了名为 `assetsLock` 的互斥锁，用于保证多协程安全的访问；
4. 实现了 `GetAssets()` 函数用于返回缓存中所有 `Asset` 对象；
5. 实现了 `RemoveAsset()` 函数用于移除缓存中指定的 `Asset` 对象；
6. 实现了 `LoadAssets()` 函数用于加载所有项目中的数据文件，并将文件的相关信息存入到 `assetsCache` 中。

该文件的主要作用是实现对所有数据文件的缓存处理，以便快速地获取和查询数据文件的信息和所在路径。

## [1/2] ial.go

此文件为 Golang 编写的“缓存”程序包中的一个文件，文件名为 ial.go。其中定义了两个缓存变量：docIALCache 和 blockIALCache，用于缓存文档和块的 IAL（内部属性列表）。

此文件定义了以下公共方法：PutDocIAL、GetDocIAL、RemoveDocIAL、ClearDocsIAL、PutBlockIAL、GetBlockIAL 和 RemoveBlockIAL，用于操作这些缓存。

在具体实现中，使用了 ristretto 缓存库。此程序在 GNU Affero 通用公共许可证下发布，用于构建一个数字园。

